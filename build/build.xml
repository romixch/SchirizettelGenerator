<project name="Build" default="pack">
	<property name="src.dir" location="../src" />
	<property name="src.test.dir" location="../test" />
	<property name="dist.dir" location="../dist" />
	<property name="build.dir" location="../dist/bin" />
	<property name="build.test.dir" location="../dist/test/bin" />
	<property name="root" location="../" />
	<property name="reportEngine.lib.dir" location="../lib/birt-runtime-4_3_1/ReportEngine" />
	<property name="junit.dir" location="../lib/junit" />
	<property name="junit.report.dir" location="../dist/junitreport" />

	<target name="clean">
		<delete dir="${build.dir}" />
		<delete dir="${dist.dir}" />
	</target>

	<target name="makedir">
		<mkdir dir="${build.dir}" />
		<mkdir dir="${dist.dir}" />
		<mkdir dir="${build.test.dir}" />
		<mkdir dir="${junit.report.dir}" />
	</target>

	<target name="compile" depends="clean, makedir">
		<javac srcdir="${src.dir}" destdir="${build.dir}" classpathref="build.classpath">
		</javac>
		<javac srcdir="${src.test.dir}" destdir="${build.test.dir}">
			<classpath refid="build.classpath" />
			<classpath path="${build.dir}" />
			<classpath refid="junit.classpath" />
		</javac>
	</target>

	<target name="junit">
		<junit haltonerror="true" haltonfailure="true">
			<classpath refid="junit.classpath" />
			<classpath path="${build.test.dir}" />
			<classpath refid="build.classpath" />
			<classpath path="${build.dir}" />
			<batchtest todir="${junit.report.dir}">
				<fileset dir="${src.test.dir}">
					<include name="**/*Test.java" />
				</fileset>
				<formatter type="xml" />
			</batchtest>
		</junit>
	</target>

	<target name="jar" depends="compile, junit">
		<jar destfile="${build.dir}/schirizettel.jar" basedir="${build.dir}">
			<manifest>
				<attribute name="Main-Class" value="ch.romix.schirizettel.generator.GeneratorGUI" />
				<attribute name="Class-Path" value="${mf.classpath}" />
			</manifest>
		</jar>
	</target>

	<target name="pack" depends="jar">
		<zip destfile="${dist.dir}/schirizettel.zip">
			<fileset dir="${reportEngine.lib.dir}" includes="lib/**.jar" />
			<fileset dir="${build.dir}" includes="schirizettel.jar" />
			<fileset dir="${root}" includes="*.rptdesign" />
			<fileset dir="${root}" includes="*README.txt" />
			<fileset dir="${root}" includes="BeispielDaten.csv" />
		</zip>
	</target>

	<path id="build.classpath">
		<fileset dir="${reportEngine.lib.dir}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="junit.classpath">
		<fileset dir="${junit.dir}">
			<include name="*.jar" />
		</fileset>
	</path>

	<pathconvert property="mf.classpath" pathsep=" ">
		<path refid="build.classpath" />
		<mapper>
			<chainedmapper>
				<flattenmapper />
				<globmapper from="*.jar" to="lib/*.jar" />
			</chainedmapper>
		</mapper>
	</pathconvert>
</project>